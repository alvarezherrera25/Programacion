import cv2
import numpy as np
import mss
import keyboard
import time
import pyautogui
import winsound
from threading import Thread
# --- CONFIGURACIÓN ---
TECLA_DISPARO = '9'
TECLA_APRENDER = 'l'    
TECLA_ACTIVAR = 'n'     
TECLA_SALIR = 'ñ'
# Tamaño de la zona de captura
ANCHO_SCAN = 60
ALTO_SCAN = 60
# --- ESTADO GLOBAL ---
target_mean = None  
target_std = None   
trained = False     
running = False
program_active = True
screen_width, screen_height = pyautogui.size()
monitor = {
    "top": int((screen_height // 2) - (ALTO_SCAN // 2)),
    "left": int((screen_width // 2) - (ANCHO_SCAN // 2)),
    "width": int(ANCHO_SCAN),
    "height": int(ALTO_SCAN)
}
def capture_screen(sct_instance):
    img = np.array(sct_instance.grab(monitor))
    img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)
    img_hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)
    return img, img_hsv
def learn_target():
    global target_mean, target_std, trained
    print(f"\n[AI] APRENDIENDO... (Mantén el mouse quieto)")
    winsound.Beep(1000, 200) # Sonido de inicio
    
    samples = []
    start_time = time.time()
    
    with mss.mss() as sct_local:
        while time.time() - start_time < 1.0:
            _, img_hsv = capture_screen(sct_local)
            # Muestrea el centro exacto
            center_h, center_w = ALTO_SCAN // 2, ANCHO_SCAN // 2
            roi = img_hsv[center_h-4:center_h+4, center_w-4:center_w+4]
            pixels = roi.reshape(-1, 3)
            samples.append(pixels)
            time.sleep(0.01)
    
    all_pixels = np.vstack(samples)
    target_mean = np.mean(all_pixels, axis=0)
    target_std = np.std(all_pixels, axis=0)
    
    # IMPORTANTE: Aseguramos una tolerancia mínima para que no sea imposible de acertar
    # Aumenté un poco los valores para que sea más fácil que detecte
    target_std = np.maximum(target_std, np.array([8.0, 20.0, 20.0]))
    
    trained = True
    print(f"[AI] APRENDIDO: {target_mean.astype(int)}")
    winsound.Beep(1500, 200) # Sonido de confirmación
def ai_bot_logic():
    global running
    print(f"[Sistema] Hilo de visión iniciado.")
    with mss.mss() as sct_thread:
        while program_active:
            if trained:
                # 1. Capturar imagen
                img_bgr, img_hsv = capture_screen(sct_thread)
                
                # 2. Calcular coincidencia (Máscara)
                lower = target_mean - (target_std * 2.8) # 2.8 desviaciones (más permisivo)
                upper = target_mean + (target_std * 2.8)
                mask = cv2.inRange(img_hsv, lower, upper)
                
                # 3. MOSTRAR VISOR (DEBUG)
                # Esto mostrará qué está viendo el bot. Blanco = Detectado.
                cv2.imshow("Ojo del Bot (Negro=Nada, Blanco=Color)", mask)
                cv2.waitKey(1)
                
                # 4. Lógica de disparo
                if running:
                    # Contamos píxeles blancos en la máscara
                    pixels_found = np.count_nonzero(mask)
                    
                    if pixels_found > 10: # Si ve más de 10 píxeles del color
                        # Pulsación ROBUSTA (Mantiene pulsado 40ms)
                        keyboard.press(TECLA_DISPARO)
                        time.sleep(0.04) 
                        keyboard.release(TECLA_DISPARO)
                        
                        # Feedback visual en consola (opcional)
                        # print(f"¡DISPARO! Pixeles: {pixels_found}")
                        
                        # Espera para no ametrallar
                        time.sleep(0.15)
            else:
                time.sleep(0.1)
                
    cv2.destroyAllWindows()
def main():
    global running, program_active
    
    print("--- PROYECTO CLASE: DETECTOR VISUAL ---")
    print("1. Pon el mouse sobre el objeto morado.")
    print("2. Pulsa 'L' para calibrar.")
    print("3. Pulsa 'N' para activar.")
    print("Mira la ventana 'Ojo del Bot': Debe ponerse BLANCA cuando pasas por el color.")
    t = Thread(target=ai_bot_logic)
    t.start()
    
    try:
        while program_active:
            if keyboard.is_pressed(TECLA_SALIR):
                program_active = False
                break
            
            if keyboard.is_pressed(TECLA_APRENDER):
                running = False 
                learn_target()
                time.sleep(0.5) 
                
            if keyboard.is_pressed(TECLA_ACTIVAR):
                if not trained: 
                    print("¡Calibra primero con L!")
                else:
                    running = not running
                    sound = 2000 if running else 500
                    winsound.Beep(sound, 100)
                    print(f"Estado: {'ACTIVO' if running else 'PAUSA'}")
                time.sleep(0.3)
                
            time.sleep(0.01)
    except KeyboardInterrupt:
        pass
    
    program_active = False
    t.join()
if __name__ == "__main__":
    main()